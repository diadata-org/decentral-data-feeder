name: decentral-data-feeder-pull-request-pipeline

on:
  pull_request:
    branches:
      - master
    paths-ignore:
      - '**.md'
      - '.gitignore'
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  ACTIONS_STEP_DEBUG: ${{ secrets.ACTIONS_STEP_DEBUG }}

jobs:
  push_image_and_deploy:
    runs-on: ubuntu-latest
    environment:
      name: dia-testspace
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest

      - name: Get Short Commit Hash
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV

      - name: Detect changed sources
        run: |
          # Get changed files comparing to base branch
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          echo "Changed files:"
          echo "$CHANGED_FILES"

          DEPLOY_TWELVEDATA=false
          DEPLOY_PARTICULA=false
          DEPLOY_ALL=false

          for file in $CHANGED_FILES; do
            case "$file" in
              pkg/scraper/twelvedata.go)
                DEPLOY_TWELVEDATA=true
                echo "Twelvedata scraper changed"
                ;;
              pkg/scraper/particula.go)
                DEPLOY_PARTICULA=true
                echo "Particula scraper changed"
                ;;
              *.md|.gitignore)
                # Ignore docs
                ;;
              *)
                DEPLOY_ALL=true
                echo "Common code changed: $file"
                ;;
            esac
          done

          if [ "$DEPLOY_ALL" = true ]; then
            DEPLOY_TWELVEDATA=true
            DEPLOY_PARTICULA=true
          fi

          echo "DEPLOY_TWELVEDATA=$DEPLOY_TWELVEDATA" >> $GITHUB_ENV
          echo "DEPLOY_PARTICULA=$DEPLOY_PARTICULA" >> $GITHUB_ENV

          echo "Deploy twelvedata: $DEPLOY_TWELVEDATA"
          echo "Deploy particula: $DEPLOY_PARTICULA"

      - name: Checkout lumina-infra repository
        env:
          LUMINA_INFRA_PAT: ${{ secrets.LUMINA_INFRA_PAT }}
        run: |
          rm -rf lumina-infra
          git clone -q https://$LUMINA_INFRA_PAT@github.com/diadata-org/lumina-infra lumina-infra

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push to AWS ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: commit-hash-${{ env.COMMIT_HASH }}
        run: |
          docker build -f build/Dockerfile-luminaDataFeeder -t ${ECR_REGISTRY}/lumina/decentral-data-feeder:${IMAGE_TAG} .
          docker push ${ECR_REGISTRY}/lumina/decentral-data-feeder:${IMAGE_TAG}
          echo "Pushed image to AWS ECR:"
          echo "  ${ECR_REGISTRY}/lumina/decentral-data-feeder:${IMAGE_TAG}"

      - name: Update AWS testnet feeder values and push to lumina-infra
        env:
          LUMINA_INFRA_PAT: ${{ secrets.LUMINA_INFRA_PAT }}
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          cd lumina-infra

          git config user.name "DIA Lumina Bot"
          git config user.email "infrastructure@diadata.org"

          # Update twelvedata testnet feeders if needed
          if [ "$DEPLOY_TWELVEDATA" = true ]; then
            echo "Updating twelvedata testnet feeders..."
            TWELVEDATA_FEEDERS="201-data-feeder-twelvedata-testnet-aws 204-data-feeder-twelvedata-testnet-aws 205-data-feeder-twelvedata-testnet-aws 206-data-feeder-twelvedata-testnet-aws 207-data-feeder-twelvedata-testnet-aws"
            for feeder in $TWELVEDATA_FEEDERS; do
              VALUES_FILE="helmcharts/data-feeders-aws/twelvedata/${feeder}/values.yaml"
              if [ -f "$VALUES_FILE" ]; then
                echo "Updating $VALUES_FILE"
                sed -i "s|image: [^,]*|image: ${ECR_REGISTRY}/lumina/decentral-data-feeder|" "$VALUES_FILE"
                sed -i "s|tag: [^}]*|tag: commit-hash-${{ env.COMMIT_HASH }}|" "$VALUES_FILE"
              fi
            done
          fi

          # Update particula testnet feeders if needed
          if [ "$DEPLOY_PARTICULA" = true ]; then
            echo "Updating particula testnet feeders..."
            PARTICULA_FEEDERS="401-data-feeder-particula-testnet-aws 402-data-feeder-particula-testnet-aws 403-data-feeder-particula-testnet-aws 404-data-feeder-particula-testnet-aws 405-data-feeder-particula-testnet-aws"
            for feeder in $PARTICULA_FEEDERS; do
              VALUES_FILE="helmcharts/data-feeders-aws/particula/${feeder}/values.yaml"
              if [ -f "$VALUES_FILE" ]; then
                echo "Updating $VALUES_FILE"
                sed -i "s|image: [^,]*|image: ${ECR_REGISTRY}/lumina/decentral-data-feeder|" "$VALUES_FILE"
                sed -i "s|tag: [^}]*|tag: commit-hash-${{ env.COMMIT_HASH }}|" "$VALUES_FILE"
              fi
            done
          fi

          echo "Changes to be committed:"
          git diff helmcharts/data-feeders-aws/ || true

          if ! git diff --quiet; then
            git add helmcharts/data-feeders-aws/
            git commit -m "PR #${{ github.event.pull_request.number }}: Update data-feeders to commit-hash-${{ env.COMMIT_HASH }}"
            git push https://$LUMINA_INFRA_PAT@github.com/diadata-org/lumina-infra.git HEAD:master
            echo "Pushed updates to lumina-infra. ArgoCD will sync data-feeders automatically."
          else
            echo "No changes to commit"
          fi

          cd ..

      - name: Cleanup cloned repository
        run: |
          rm -rf lumina-infra
